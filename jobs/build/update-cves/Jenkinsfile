node {
    checkout scm
    def commonlib = load("pipeline-scripts/commonlib.groovy")

    // Expose properties for a parameterized build
    properties(
        [
            buildDiscarder(
                logRotator(
                    artifactDaysToKeepStr: '',
                    artifactNumToKeepStr: '',
                    daysToKeepStr: '60',
                    numToKeepStr: '')
            ), disableConcurrentBuilds()
            [
                $class: 'ParametersDefinitionProperty',
                parameterDefinitions: [
                    [
                        name: 'VERSIONS',
                        description: 'CSV list of openshift versions to update streams.yml.',
                        $class: 'hudson.model.StringParameterDefinition',
                        defaultValue: commonlib.ocp3UpdateCVEVersions.join(',')
                    ],
                    [
                        name: 'REPO_URL',
                        description: 'Failure Mailing List',
                        $class: 'hudson.model.StringParameterDefinition',
                        defaultValue: 'git@github.com:openshift/ocp-build-data.git',
                    ],
                    [
                        name: 'MAIL_LIST_FAILURE',
                        description: 'Failure Mailing List',
                        $class: 'hudson.model.StringParameterDefinition',
                        defaultValue: [
                            'aos-team-art@redhat.com',
                        ].join(',')
                    ],
                    commonlib.mockParam(),
                ]
            ],
            disableConcurrentBuilds()
        ]
    )

    commonlib.checkMock()

    ocpVersions = params.VERSIONS.split(',')
    repo = params.REPO_URL
    currentBuild.displayName = "#${currentBuild.number} Update CVEs versions ${params.VERSIONS}"
    currentBuild.description = ""

    try {
        successful = []
        sshagent(["openshift-bot"]) {
            stage("Clone ocp-build-data ") {
             for(int i = 0; i < ocpVersions.size(); ++i) {
                def branch = "openshift-" + ocpVersions[i]
                def workDir = "${env.WORKSPACE}/openshift-" + ocpVersions[i]
                def targetFile =  "${workDir}/streams.yml"

                commonlib.shell """
                    rm -rf ${workDir}"
                    git clone ${repo} --single-branch --branch ${branch} --depth 1 ${workDir}"
                    python ./update-cves.py -f ${targetFile}"
                    cd ${workDir}"
                    git diff"
                    git add ${targetFile}"
                    git commit -m 'updating ${branch} streams.yml'"
                    git push origin HEAD:${branch}"
                """
             }

            }
        }

    } catch (err) {
        commonlib.email(
            to: "${params.MAIL_LIST_FAILURE}",
            from: "aos-team-art@redhat.com",
            subject: "Unexpected error during CVEs update streams.yml!",
            body: "Encountered an unexpected error while running CVEs update streams.yml: ${err}"
        )

        throw err
    }
}